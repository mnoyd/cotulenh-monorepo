# Stack Selection Destination Highlighting - Final Fix

## Problem Summary

When clicking on a stack (e.g., Tank+Militia), the board was showing **all possible destinations** for **all pieces** in the stack combined, instead of showing only the carrier's (base piece) legal moves.

## Root Cause

The `mapPossibleMovesToDests` function was not correctly filtering moves. The core generates moves for:

1. **Whole stack moves** (carrier with carrying array)
2. **Individual piece moves** from the stack (each carried piece)

The UI was mapping ALL of these moves, creating a confusing display.

## Solution

Filter moves based on whether they represent whole-stack movement or individual piece movement:

```typescript
const isStack = pieceAtSquare.carrying && pieceAtSquare.carrying.length > 0;

if (!isStack) {
  // Single piece (no stack) - always map
  piecesToMap.push(move.piece);
} else {
  // Stack exists - only map if this move is for the whole stack (carrier)
  // Carrier moves have carrying as an array (even if empty)
  // Individual piece moves have carrying as undefined
  if (Array.isArray(move.piece.carrying)) {
    piecesToMap.push(move.piece);
  }
  // Skip individual carried piece moves
}
```

### Key Insight

For moves generated by the core:

- **Whole stack move**: `move.piece.carrying` is an **array** (the carrier with its carried pieces)
- **Individual piece move**: `move.piece.carrying` is **undefined** (just that one piece)
- **Single piece**: `move.piece.carrying` is **undefined** (no stack exists)

Using `Array.isArray(move.piece.carrying)` correctly identifies carrier moves vs individual piece moves.

## Dual Key System

For stacks, we create two keys:

1. **With type** (`"h4.tank"`): For when user selects Tank from popup
2. **Without type** (`"h4.undefined"`): For when user clicks stack directly

```typescript
// Always create key with type
const keyWithType = origMoveToKey(moveOrig);
dests.set(keyWithType, destinations);

// For carrier on stack: also create key without type
if (isCarrier && isStack && !move.isDeploy()) {
  const keyWithoutType = `${move.from}.undefined` as OrigMoveKey;
  dests.set(keyWithoutType, destinations);
}
```

## User Experience After Fix

### Scenario 1: Click Single Piece

- Shows that piece's legal moves ✅

### Scenario 2: Click Stack (No Popup)

- Shows only carrier's legal moves ✅
- Carried pieces' moves are hidden

### Scenario 3: Open Popup → Select Piece

- Shows only that selected piece's legal moves ✅

### Scenario 4: Deploy Mode

- Shows all pieces' moves (unchanged) ✅

## Files Changed

**`/apps/cotulenh-app/src/routes/+page.svelte`** (lines 79-155)

- Modified `mapPossibleMovesToDests` function
- Added filtering logic for stack vs single piece moves
- Implemented dual-key system for stack carrier moves

## Testing Checklist

- ✅ Single piece shows correct destinations
- ✅ Stack click shows only carrier destinations
- ✅ Popup selection shows only selected piece destinations
- ✅ Deploy mode shows all pieces' destinations
- ✅ Move execution works correctly
- ✅ No TypeScript errors

## Technical Notes

### Why `Array.isArray()` Works

The core's `Move` class sets `piece.carrying` based on the internal move:

- For stack moves: `piece` includes the `carrying` array
- For individual moves: `piece` is just that piece (no `carrying` property, or `undefined`)

### Property Existence Check Pitfall

Initially tried `'carrying' in move.piece`, but ALL pieces have the `carrying` property (set to `undefined` for non-stack pieces). This made the check useless.

`Array.isArray()` correctly distinguishes:

- `Array.isArray([])` → `true` (carrier with empty array)
- `Array.isArray([piece1, piece2])` → `true` (carrier with pieces)
- `Array.isArray(undefined)` → `false` (individual piece or single piece)

## Related Fixes

This fix works in conjunction with:

1. **Deploy Session FEN Fix** - Ensures FEN shows current board state
2. **Deploy Mode Auto-Detection** - Automatically sets `deploy: true` during sessions

Together, these fixes provide a seamless deploy and stack interaction experience.
