<!doctype html>
<html>
  <head>
    <title>Deploy State Parsing Test</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f5f5f5;
      }
      .test {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #4a90e2;
      }
      .test.pass {
        border-left-color: #27ae60;
      }
      .test.fail {
        border-left-color: #e74c3c;
      }
      .fen {
        background: #f0f0f0;
        padding: 5px;
        margin: 5px 0;
        border-radius: 3px;
        word-break: break-all;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 3px;
      }
      h1 {
        color: #333;
      }
      h2 {
        color: #666;
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>Deploy State FEN Parsing Test</h1>
    <div id="tests"></div>

    <script type="module">
      // Mock the FEN parsing logic
      function readWithDeployState(fen) {
        // Check for DEPLOY marker in extended FEN format
        const deployMatch = fen.match(/^(.+)\s+DEPLOY\s+([a-k](?:1[0-2]|[1-9])):(.*)$/);

        if (!deployMatch) {
          return {
            pieces: 'parsed-pieces',
            deployState: null,
          };
        }

        // Extended FEN with deploy state
        const [_, baseFEN, square, moveStr] = deployMatch;

        // Parse deploy moves
        const isComplete = !moveStr.endsWith('...');
        const cleanMoveStr = moveStr.replace(/\.\.\.$/, '');
        const moves = parseDeployMoves(cleanMoveStr);

        return {
          pieces: 'parsed-pieces',
          deployState: {
            originSquare: square,
            moves,
            isComplete,
          },
        };
      }

      function parseDeployMoves(moveStr) {
        if (!moveStr || moveStr.trim() === '') return [];

        return moveStr.split(',').map(moveNotation => {
          const captureMatch = moveNotation.match(/([A-Z])(\([A-Z]+\))?(x)?([a-k](?:1[0-2]|[1-9]))/);
          if (!captureMatch) {
            throw new Error(`Invalid deploy move notation: ${moveNotation}`);
          }

          const [__, piece, carrying, capture, to] = captureMatch;
          return {
            piece: carrying ? `${piece}${carrying}` : piece,
            to: to,
            capture: !!capture,
          };
        });
      }

      // Test cases
      const tests = [
        {
          name: 'Normal FEN (no deploy state)',
          fen: '6c4/1n2fh1hf2/3a2s2a1/2n1gt1tg2/2ie2m2ei/11/11/2IE2M2EI/2N1GT1TG2/3A2S2A1/1N2FH1HF2/6C4 r - - 0 1',
          expected: {
            deployState: null,
          },
        },
        {
          name: 'Deploy started (no moves yet)',
          fen: '6c4/1n2fh1hf2/3a2s2a1/2n1gt1tg2/2ie2m2ei/11/11/2IE2M2EI/2N1GT1TG2/3A2S2A1/1N2FH1HF2/6C4 r - - 0 1 DEPLOY c3:',
          expected: {
            deployState: {
              originSquare: 'c3',
              moves: [],
              isComplete: true,
            },
          },
        },
        {
          name: 'One move deployed (incomplete)',
          fen: '6c4/1n2fh1hf2/3a2s2a1/2n1gt1tg2/2ie2m2ei/11/11/2IE2M2EI/2N1GT1TG2/3A2S2A1/1N2FH1HF2/6C4 r - - 0 1 DEPLOY c3:Nc5...',
          expected: {
            deployState: {
              originSquare: 'c3',
              moves: [{ piece: 'N', to: 'c5', capture: false }],
              isComplete: false,
            },
          },
        },
        {
          name: 'Multiple moves with capture (incomplete)',
          fen: '6c4/1n2fh1hf2/3a2s2a1/2n1gt1tg2/2ie2m2ei/11/11/2IE2M2EI/2N1GT1TG2/3A2S2A1/1N2FH1HF2/6C4 r - - 0 1 DEPLOY c3:Nc5,F(EI)xd4,Te5...',
          expected: {
            deployState: {
              originSquare: 'c3',
              moves: [
                { piece: 'N', to: 'c5', capture: false },
                { piece: 'F(EI)', to: 'd4', capture: true },
                { piece: 'T', to: 'e5', capture: false },
              ],
              isComplete: false,
            },
          },
        },
        {
          name: 'Complete deployment',
          fen: '6c4/1n2fh1hf2/3a2s2a1/2n1gt1tg2/2ie2m2ei/11/11/2IE2M2EI/2N1GT1TG2/3A2S2A1/1N2FH1HF2/6C4 r - - 0 1 DEPLOY c3:Nc5,Te5',
          expected: {
            deployState: {
              originSquare: 'c3',
              moves: [
                { piece: 'N', to: 'c5', capture: false },
                { piece: 'T', to: 'e5', capture: false },
              ],
              isComplete: true,
            },
          },
        },
      ];

      // Run tests
      const testsDiv = document.getElementById('tests');
      let passCount = 0;
      let failCount = 0;

      tests.forEach(test => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test';

        try {
          const result = readWithDeployState(test.fen);
          const passed = JSON.stringify(result.deployState) === JSON.stringify(test.expected.deployState);

          if (passed) {
            testDiv.classList.add('pass');
            passCount++;
          } else {
            testDiv.classList.add('fail');
            failCount++;
          }

          testDiv.innerHTML = `
          <h2>${passed ? '✅' : '❌'} ${test.name}</h2>
          <div class="fen"><strong>FEN:</strong> ${test.fen}</div>
          <div class="result">
            <strong>Expected:</strong><br>
            <pre>${JSON.stringify(test.expected.deployState, null, 2)}</pre>
            <strong>Got:</strong><br>
            <pre>${JSON.stringify(result.deployState, null, 2)}</pre>
          </div>
        `;
        } catch (error) {
          testDiv.classList.add('fail');
          failCount++;
          testDiv.innerHTML = `
          <h2>❌ ${test.name}</h2>
          <div class="fen"><strong>FEN:</strong> ${test.fen}</div>
          <div class="result">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
        }

        testsDiv.appendChild(testDiv);
      });

      // Summary
      const summary = document.createElement('div');
      summary.className = 'test';
      summary.innerHTML = `
      <h2>Summary</h2>
      <div class="result">
        <strong>Total:</strong> ${tests.length}<br>
        <strong>Passed:</strong> ${passCount}<br>
        <strong>Failed:</strong> ${failCount}
      </div>
    `;
      testsDiv.appendChild(summary);
    </script>
  </body>
</html>
